# Реализация фильтрации LDAP по группам

## Обзор
Этот документ описывает реализацию фильтрации LDAP по членству в группах в OIDC LDAP прокси.

## Внесенные изменения

### 1. Управление сессиями
- Добавлен словарь `user_sessions` для хранения информации о сессии пользователя
- Каждая сессия содержит: `{bind_dn: {'access_token': ..., 'groups': [...]}}`
- Добавлен `current_bound_dn` для отслеживания текущего аутентифицированного пользователя в соединении

### 2. Извлечение информации о группах
- Реализован метод `get_groups_from_token()` для извлечения информации о группах из OIDC токенов доступа
- Добавлен метод `filter_entries_by_group_membership()` для фильтрации записей LDAP на основе членства пользователя в группах

### 3. Обновления аутентификации
- Изменена обработка `LDAPBindRequest` для сохранения информации о сессии пользователя после успешной аутентификации
- Установлен `current_bound_dn` когда пользователь успешно привязывается к серверу LDAP

### 4. Обработка запросов поиска
- Улучшена обработка `LDAPSearchRequest` для извлечения информации о группах из фильтров поиска
- Реализована фильтрация результатов поиска на основе членства пользователя в группах
- Передача запросов поиска на реальный сервер LDAP с применением контроля доступа на основе групп

## Примеры фильтров LDAP

Реализация обрабатывает различные паттерны фильтров LDAP по группам:

1. **Прямое членство в группе**:
   - `(memberOf=cn=developers,ou=groups,dc=example,dc=org)`

2. **Комбинированные фильтры**:
   - `(&(objectClass=user)(memberOf=cn=developers,ou=groups,dc=example,dc=org))`

## Как работает фильтрация по группам

1. Когда пользователь аутентифицируется через OIDC, его членство в группах извлекается из токена доступа
2. Когда выполняется запрос поиска, прокси извлекает фильтры групп из поискового запроса
3. Прокси передает поиск на реальный сервер LDAP
4. Перед возвратом результатов прокси фильтрует записи на основе членства пользователя в группах
5. Возвращаются только те записи, к которым пользователь имеет право доступа

## Конфигурация

Прокси использует следующие переменные окружения:

- `LDAP_PROXY_TOKEN_URL`: конечная точка OIDC токена
- `LDAP_PROXY_CLIENT_ID`: OIDC идентификатор клиента
- `LDAP_PROXY_CLIENT_SECRET`: OIDC секрет клиента
- `REAL_LDAP_SERVER`: конечная точка реального сервера LDAP (по умолчанию: ldap://localhost:389)

## Архитектура

Прокси теперь устанавливает реальное соединение с сервером LDAP для выполнения поиска, сохраняя при этом уровень аутентификации OIDC. Это позволяет обеспечить надлежащую фильтрацию результатов поиска на основе групп.